import{populate_grid as e}from"./graphs.js";import{resources as t}from"./resources.js";document.getElementById("mapdiv").offsetWidth,document.getElementById("mapdiv").offsetHeight;var n={},a=[],d=[],i=[],s=30,l=0,c=[];export function main(){var o=document.createElement("div");o.classList.add("centerElDiv");var m=document.createElement("div");m.innerHTML="<h3> <i> -COVID-Life- <i> </h3>",m.classList.add("mainTitle");var g=document.createElement("div"),h=document.createElement("div"),f=document.createElement("div"),E=document.createElement("div"),L=document.getElementsByClassName("close")[0],k=document.getElementsByClassName("close")[1],C=document.getElementsByClassName("close")[2];g.innerHTML="Start game",h.innerHTML="Introduction",f.innerHTML="Instructions",E.innerHTML="Credits",g.classList.add("mainmenuItem"),h.classList.add("mainmenuItem"),f.classList.add("mainmenuItem"),E.classList.add("mainmenuItem"),g.addEventListener("click",(function(){!function(t){s=30,l=-1,n=e(),y();for(var r=0;r<2;r++)n.update();t.init(),y();var o=n.score();i=o,d=t.getResState();var m=document.getElementById("mapdiv");m.querySelectorAll("*").forEach(e=>e.remove()),m.classList.remove("centerElDiv"),m.classList.add("gameDiv");var g=document.createElement("div"),h=document.createElement("div"),f=document.createElement("div");g.classList.add("spacebar"),h.classList.add("gameScreen"),f.classList.add("scoreScreen"),m.appendChild(h),m.appendChild(f),g.innerHTML='<i class="fa fa-play-circle fa-2x" aria-hidden="true"> Start </i> / <i class="fa fa-arrow-circle-o-right fa-2x" aria-hidden="true"> Forward </i> ',g.addEventListener("click",(function(){v()}));var E=document.createElement("div");E.innerHTML="Time Left: --- days",E.classList.add("scoreContent"),E.id="timeleft",(t=document.createElement("div")).innerHTML="Clicks left: --- ",t.classList.add("scoreContent"),t.id="resources";o[1],o[2];var L=document.createElement("div");L.innerHTML="Green cells  : --- %",L.classList.add("scoreContent"),L.id="safe";var k=document.createElement("div");k.innerHTML="Green connected: --- %",k.classList.add("scoreContent"),k.id="connected";var C=document.createElement("div");C.innerHTML='<i class="fa fa-info-circle fa-2x" aria-hidden="true"> Instructions </i>',C.classList.add("infoContent"),C.id="infoIcon";var T=document.getElementsByClassName("close")[1];C.addEventListener("click",(function(){document.getElementById("instructionsText").style.display="block"})),T.addEventListener("click",(function(){document.getElementById("instructionsText").style.display="none"})),window.addEventListener("click",(function(e){e.target==document.getElementById("instructionsText")&&(document.getElementById("instructionsText").style.display="none")})),f.appendChild(g),f.appendChild(E),f.appendChild(t),f.appendChild(L),f.appendChild(k),f.appendChild(C);var x=h.offsetWidth,I=h.offsetHeight,B=d3.select(".gameScreen").append("svg").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+x+" "+I).attr("id","theSvg").style("background","#ffffff"),b=B.node().getBoundingClientRect(),M=b.width,w=b.height;B.selectAll("text").remove(),B.on("click",null),a=n.nodesToPlot(),c.push({time:l,state:a});var H=B.selectAll("rect").data(a).enter().append("rect"),S=M/15,A=w/15;H.attr("x",(function(e,t){return e.x*S})).attr("y",(function(e,t){return e.y*A})).attr("width",S).attr("height",A).style("fill",(function(e){return"grey"})).style("fill-opacity",(function(e){return e.opacity})).attr("rx",1).attr("class","dropzone").attr("class","connected").classed("cells",!0).classed("shadow",!0).attr("xpos",(function(e){return e.x})).attr("ypos",(function(e){return e.y})),H.call(p),document.addEventListener("keypress",u)}(t)})),h.addEventListener("click",(function(){document.getElementById("introText").style.display="block"})),f.addEventListener("click",(function(){document.getElementById("instructionsText").style.display="block"})),E.addEventListener("click",(function(){document.getElementById("creditsText").style.display="block"})),L.addEventListener("click",(function(){document.getElementById("introText").style.display="none"})),k.addEventListener("click",(function(){document.getElementById("instructionsText").style.display="none"})),C.addEventListener("click",(function(){document.getElementById("creditsText").style.display="none"})),window.addEventListener("click",(function(e){e.target==document.getElementById("introText")?document.getElementById("introText").style.display="none":e.target==document.getElementById("instructionsText")?document.getElementById("instructionsText").style.display="none":e.target==document.getElementById("creditsText")&&(document.getElementById("creditsText").style.display="none")})),f.addEventListener("click",f),E.addEventListener("click",r),o.appendChild(m),o.appendChild(g),o.appendChild(h),o.appendChild(f),o.appendChild(E),document.getElementById("mapdiv").appendChild(o)}function r(e){document.removeEventListener("keypress",u),document.body.style.cursor="default",e.selectAll("path").remove(),e.selectAll(".road").remove(),e.selectAll("end").remove();var t=document.getElementById("mapdiv");t.querySelectorAll("*").forEach(e=>e.remove()),null,n.update();for(var a=n.score(),d=n.retrieveScore(),s=[],l=[],r=[],m=[],p=0;p<d.length;p++)m.push(p),s.push(d[p].i),l.push(d[p].s),r.push(d[p].cs);t.classList.remove("gameDiv"),t.classList.add("graphDiv");var y=document.createElement("div"),v=document.createElement("div"),g=document.createElement("div"),h=document.createElement("div");y.classList.add("graphScreen"),v.classList.add("spacediv"),g.classList.add("feedback"),h.classList.add("newgame"),t.appendChild(v),t.appendChild(y),t.appendChild(g),t.appendChild(h);var f=document.createElement("p");g.appendChild(f);var E=document.createElement("div");E.classList.add("graphs"),E.id="infected";var L=document.createElement("div");L.classList.add("graphs"),L.id="safe";var k=document.createElement("div");k.classList.add("graphs"),k.id="connected",y.appendChild(E),y.appendChild(L),y.appendChild(k);var C=document.createElement("p");C.innerHTML="Infected",C.classList.add("graphtitle"),E.appendChild(C),o("infected",s);var T=document.createElement("p");T.innerHTML="Safe",T.classList.add("graphtitle"),L.appendChild(T),o("safe",l);var x=document.createElement("p");x.innerHTML="Connected",x.classList.add("graphtitle"),k.appendChild(x),o("connected",r);let I=i,B=a;B[0],I[0];var b=B[1]-I[1],M=parseInt(100*(B[2]-I[2])/I[2]);f.innerHTML=b>0&&M>0?"You have saved "+b+" infected people and improved connectivity by "+M+"%. This is quite a good solution for the game. Can we analyze your gameplay?":b>0?"You have saved "+b+" infected people. This could be potential solution for safely exiting COVID-19 lockdowns. Will you allow us to collect and analyze your gameplay strategies?":M>0?"You have improved connectivity by "+M+"% <br> This is quite a good solution for improving human mobility. Will you allow us to collect and analyze your gameplay strategies?":"We are sorry that you couldn't save the city. We encourage you to try again to improve gameplay. Would you give this another try?";var w=document.createElement("p");w.classList.add("pboxed");var H=document.createElement("p");H.classList.add("pboxed"),w.innerHTML="New game",H.innerHTML="Submit",h.appendChild(H),h.appendChild(w),w.addEventListener("click",(function(){var e=document.getElementById("mapdiv");e.querySelectorAll("*").forEach(e=>e.remove()),e.classList.remove("graphDiv"),main()}));var S=document.getElementsByClassName("close")[3];H.addEventListener("click",(function(){document.getElementById("email").style.display="block"})),S.addEventListener("click",(function(){document.getElementById("email").style.display="none"})),window.addEventListener("click",(function(e){e.target==document.getElementById("email")&&(document.getElementById("email").style.display="none")})),document.getElementById("download").addEventListener("click",(function(){var e,t,n;e="gameplay.txt",t=JSON.stringify(c),(n=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),localStorage.setItem("gameplay",JSON.stringify(c))}))}function o(e,t){var n=document.getElementById(e).offsetWidth,a=document.getElementById(e).offsetHeight,d=d3.select("#"+e).append("svg").attr("width",n).attr("height",a).attr("fill","white").attr("class","plot"),i=n/5,s=4*n/5,l=a/5,c=3*a/4;console.log(s+" , "+c),console.log(t);var r=d3.scale.linear().domain([0,t.length]).range([i,s]),o=d3.scale.linear().domain([d3.max(t),Math.min(10,d3.min(t))]).range([l,c]);d3.svg.axis().scale(r).orient("bottom"),d3.svg.axis().scale(o).orient("left");d.append("line").style("stroke","Lightblue").style("stroke-width",4).attr("x1",r(0)).attr("y1",o(10)).attr("x2",r(t.length)).attr("y2",o(10)),d.append("line").style("stroke","Lightblue").style("stroke-width",4).attr("x1",r(0)).attr("y1",o(10)).attr("x2",r(0)).attr("y2",o(d3.max(t)));var m=d3.svg.line().x((function(e,t){return r(t)})).y((function(e){return o(e)}));d.append("path").transition().delay(200).attr("d",m(t)).style("stroke","#5c4033").style("stroke-width",3).style("fill","none")}function m(e){d=t.getResState(),document.getElementById("resources").innerHTML="Clicks left: "+d}function u(e){var t=e.charCode;d3.select("#theSvg");switch(t){case 115:"quarantine",document.body.style.cursor="copy";break;case 100:"unlock",document.body.style.cursor="url(resources/unlock.png), auto";break;case 119:"default";break;case 32:v();break;default:"default",document.body.style.cursor="default"}}d3.dispatch("click","dblclick");const p=function(){const e=d3.dispatch("click","dblclick");return d3.rebind(t=>{let n=null;t.on("click",t=>{if(d3.event.preventDefault(),null!=n)clearTimeout(n),n=null,e.dblclick(d3.event,t);else{const a=d3.event;n=setTimeout(()=>{console.log(a),e.click(a,t),n=null},300)}})},e,"on")}();function y(){for(var e=0;e<a.length;e++){var t=n.retrieveColor(a[e].y+","+a[e].x),d=n.retrieveOpacity(a[e].y+","+a[e].x);a[e].color=t,a[e].opacity=d}c.push({time:l,state:a})}function v(){var e=d3.select("#theSvg");if(l==s)return l++,null,document.removeEventListener("keypress",u),e.selectAll("rect").each((function(e){this.classList.remove("testinprogress")})),n.score(),n.update(),n.score(),y(),void r(e);l<s&&(console.log(l+" , "+s),e.selectAll("rect").each((function(e){this.classList.remove("testinprogress")})),function(e){l++,n.update(),y(),e.selectAll("path").remove(),e.selectAll(".road").remove();var a=n.score(),i=100*a[1]/225,c=100*a[2]/900;d=t.getResState(),document.getElementById("timeleft").innerHTML="Time Left: "+(s-l)+" days",document.getElementById("resources").innerHTML="Resources left: "+d,document.getElementById("safe").innerHTML="Green cells    : "+Math.round(i)+"%",document.getElementById("connected").innerHTML="Green connected : "+Math.ceil(c)+"%";var r=(e=d3.select("#theSvg")).node().getBoundingClientRect(),o=r.width,m=r.height;n.getConnectedGreen();for(var u=n.getConnections(),p=o/15,v=m/15,g=0;g<u.length;g++){var h=(f=u[g])[0];for(let t=0;t<f.length;t++)e.append("circle").attr("cx",h.x*p+.5*p).attr("cy",h.y*v+.5*v).attr("r",7).style("fill","wheat").attr("class","dropzone").classed("road",!0)}for(g=0;g<u.length;g++){var f;h=(f=u[g])[0];for(let t=0;t<f.length;t++){var E=f[t],L="M"+(Math.floor(h.x*p)+p/2)+" "+Math.floor(h.y*v+v/2)+" L"+(Math.floor(E.x*p)+p/2)+" "+Math.floor(E.y*v+v/2);e.append("path").attr("stroke-width",3).attr("d",L).style("stroke","#654321").style("stroke-width",5).style("stroke-dasharray","5, 3")}}e.selectAll(".cells").transition().duration(200).style("fill",(function(e){return e.color})).style("fill-opacity",(function(e){return e.opacity}))}(e),t.useKit(),t.replenish(),m(),n.resetTesting())}p.on("click",e=>{const a=e.target;var d=e.target.getAttribute("xpos"),i=e.target.getAttribute("ypos");t.check_testKits()>0&&0==n.alreadyTested(i+","+d)&&(n.testing(i+","+d,1),a.classList.add("testinprogress"),a.classList.remove("connected"),t.selTesting(),m())}).on("dblclick",e=>{const a=e.target;var d=e.target.getAttribute("xpos"),i=e.target.getAttribute("ypos");n.testing(i+","+d,0),a.classList.contains("testinprogress")&&(a.classList.add("connected"),a.classList.remove("testinprogress"),t.unselTesting()),m()}),main();